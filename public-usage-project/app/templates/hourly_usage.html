<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hourly Usage</title>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-2.4.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.4.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-2.4.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.bokeh.org/bokeh/release/bokeh-api-2.4.3.min.js"></script>
</head>
<body>
    <div id="myplot-hourly"></div>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() {
            fetch(window.locaiton.origin + "/api/get_hourly_usage")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetched data:', data);

                    console.log();

                    const barData = [['Hour', 'Connections']];
                    for (let i = 0; i < data.hour.length; i++) {
                        barData.push([new Date(data.hour[i]).toISOString().substring(11, 13), data.node1[i]]);
                    }

                    // console.log('Bar data:', barData);

                    const source = new Bokeh.ColumnDataSource({
                        data: {
                            hour: data.hour.map(date => new Date(date).toISOString().substring(11, 13)),
                            connections: data.node1
                        }
                    });

                    const p = new Bokeh.Plotting.figure({
                        width: 1000,
                        height: 500,
                        title: "Hourly Usage",
                        x_axis_label: 'Hour',
                        y_axis_label: 'Connections',
                        x_range: barData.slice(1).map(item => item[0]),
                        tools: "pan,wheel_zoom,box_zoom,reset,save"
                    });

                    p.vbar({
                        x: { field: 'hour' },
                        top: { field: 'connections' },
                        width: 0.9,
                        source: source
                    });

                    // Remove grid lines
                    p.xgrid[0].visible = false;
                    p.ygrid[0].visible = false;

                    // Add hover tool
                    const hover = new Bokeh.HoverTool({
                        tooltips: [
                            ["Hour", "@hour"],
                            ["Connections", "@connections"]
                        ]
                    });
                    p.add_tools(hover);

                    // Disable scientific notation on y-axis
                    p.yaxis[0].formatter = new Bokeh.NumeralTickFormatter({ format: "0a" });

                    Bokeh.Plotting.show(p, document.getElementById('myplot-hourly'));
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        });
    </script>
</body>
</html>
